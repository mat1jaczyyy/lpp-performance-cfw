#include "modes/normal/text.h"

const u8 text_points[95] = {1, 3, 5, 5, 5, 5, 2, 2, 2, 5, 5, 4, 4, 4, 5, 5, 3, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 3, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 3, 5, 3, 5, 5, 2, 5, 5, 5, 5, 5, 4, 5, 5, 2, 3, 4, 2, 5, 5, 5, 5, 5, 4, 5, 3, 5, 5, 5, 5, 5, 5, 3, 1, 3, 4, 5};

const u8 text_bitmap_data[] = {
	0b11111011, // 33 = !
	0b11100000, 0b00000000, 0b11100000, // 34 = "
	0b00101000, 0b11111110, 0b00101000, 0b11111110, 0b00101000, // 35 = #
	0b00100100, 0b01010100, 0b11111110, 0b01010100, 0b01001000, // 36 = $
	0b11000100, 0b11001000, 0b00010000, 0b00100110, 0b01000110, // 37 = %
	0b01101100, 0b10010010, 0b10010010, 0b01101100, 0b00001010, // 38 = &
	0b00100000, 0b11000000, // 39 = '
	0b01111100, 0b10000010, // 40 = (
	0b10000010, 0b01111100, // 41 = )
	0b00101000, 0b00111000, 0b01111100, 0b00111000, 0b00101000, // 42 = *
	0b00010000, 0b00010000, 0b01111100, 0b00010000, 0b00010000, // 43 = +
	0b00000000, 0b00000101, 0b00000110, 0b00000000, // 44 = ,
	0b00010000, 0b00010000, 0b00010000, 0b00010000, // 45 = -
	0b00000000, 0b00000110, 0b00000110, 0b00000000, // 46 = .
	0b00000100, 0b00001000, 0b00010000, 0b00100000, 0b01000000, // 47 = /
	0b01111100, 0b10000010, 0b10000010, 0b10000010, 0b01111100, // 48 = 0
	0b01000010, 0b11111110, 0b00000010, // 49 = 1
	0b01001110, 0b10010010, 0b10010010, 0b10010010, 0b01100010, // 50 = 2
	0b01000100, 0b10000010, 0b10010010, 0b10010010, 0b01101100, // 51 = 3
	0b00011000, 0b00101000, 0b01001000, 0b11111110, 0b00001000, // 52 = 4
	0b11100100, 0b10100010, 0b10100010, 0b10100010, 0b10011100, // 53 = 5
	0b01111100, 0b10010010, 0b10010010, 0b10010010, 0b01001100, // 54 = 6
	0b10000000, 0b10000110, 0b10011000, 0b10100000, 0b11000000, // 55 = 7
	0b01101100, 0b10010010, 0b10010010, 0b10010010, 0b01101100, // 56 = 8
	0b01100100, 0b10010010, 0b10010010, 0b10010010, 0b01111100, // 57 = 9
	0b00000000, 0b00110110, 0b00110110, 0b00000000, // 58 = :
	0b00000000, 0b00110101, 0b00110110, 0b00000000, // 59 = ;
	0b00010000, 0b00101000, 0b01000100, 0b10000010, // 60 = <
	0b00101000, 0b00101000, 0b00101000, 0b00101000, // 61 = =
	0b10000010, 0b01000100, 0b00101000, 0b00010000, // 62 = >
	0b01000000, 0b10000000, 0b10001010, 0b10010000, 0b01100000, // 63 = ?
	0b01111100, 0b10000010, 0b10010010, 0b10101010, 0b01111000, // 64 = @
	0b00000110, 0b00111000, 0b11001000, 0b00111000, 0b00000110, // 65 = A
	0b11111110, 0b10010010, 0b10010010, 0b10010010, 0b01101100, // 66 = B
	0b01111100, 0b10000010, 0b10000010, 0b10000010, 0b01000100, // 67 = C
	0b11111110, 0b10000010, 0b10000010, 0b01000100, 0b00111000, // 68 = D
	0b11111110, 0b10010010, 0b10010010, 0b10010010, 0b10000010, // 69 = E
	0b11111110, 0b10010000, 0b10010000, 0b10010000, 0b10000000, // 70 = F
	0b01111100, 0b10000010, 0b10000010, 0b10010010, 0b10011110, // 71 = G
	0b11111110, 0b00010000, 0b00010000, 0b00010000, 0b11111110, // 72 = H
	0b10000010, 0b11111110, 0b10000010, // 73 = I
	0b00000100, 0b00000010, 0b10000010, 0b11111100, // 74 = J
	0b11111110, 0b00010000, 0b00101000, 0b01000100, 0b10000010, // 75 = K
	0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, // 76 = L
	0b11111110, 0b01000000, 0b00110000, 0b01000000, 0b11111110, // 77 = M
	0b11111110, 0b01100000, 0b00010000, 0b00001100, 0b11111110, // 78 = N
	0b01111100, 0b10000010, 0b10000010, 0b10000010, 0b01111100, // 79 = O
	0b11111110, 0b10010000, 0b10010000, 0b10010000, 0b01100000, // 80 = P
	0b01111100, 0b10000010, 0b10001010, 0b10000100, 0b01111010, // 81 = Q
	0b11111110, 0b10010000, 0b10011000, 0b10010100, 0b01100010, // 82 = R
	0b01100100, 0b10110010, 0b10010010, 0b10010010, 0b01001100, // 83 = S
	0b10000000, 0b10000000, 0b11111110, 0b10000000, 0b10000000, // 84 = T
	0b11111100, 0b00000010, 0b00000010, 0b00000010, 0b11111100, // 85 = U
	0b11100000, 0b00011000, 0b00000110, 0b00011000, 0b11100000, // 86 = V
	0b11110000, 0b00001110, 0b00110000, 0b00001110, 0b11110000, // 87 = W
	0b11000110, 0b00101000, 0b00010000, 0b00101000, 0b11000110, // 88 = X
	0b11000000, 0b00100000, 0b00011110, 0b00100000, 0b11000000, // 89 = Y
	0b10000110, 0b10001010, 0b10010010, 0b10100010, 0b11000010, // 90 = Z
	0b11111110, 0b10000010, 0b10000010, // 91 = [
	0b01000000, 0b00100000, 0b00010000, 0b00001000, 0b00000100, // 92 = Backslash
	0b10000010, 0b10000010, 0b11111110, // 93 = ]
	0b00100000, 0b01000000, 0b10000000, 0b01000000, 0b00100000, // 94 = ^
	0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, // 95 = _
	0b11000000, 0b00100000, // 96 = `
	0b00000100, 0b00101010, 0b00101010, 0b00101010, 0b00011110, // 97 = a
	0b11111110, 0b00100010, 0b00100010, 0b00100010, 0b00011100, // 98 = b
	0b00011100, 0b00100010, 0b00100010, 0b00100010, 0b00100010, // 99 = c
	0b00011100, 0b00100010, 0b00100010, 0b00100010, 0b11111110, // 100 = d
	0b00011100, 0b00101010, 0b00101010, 0b00101010, 0b00011010, // 101 = e
	0b00010000, 0b01111110, 0b10010000, 0b10010000, // 102 = f
	0b00011000, 0b00100101, 0b00100101, 0b00100101, 0b00111110, // 103 = g
	0b11111110, 0b00100000, 0b00100000, 0b00100000, 0b00011110, // 104 = h
	0b10111100, 0b00000010, // 105 = i
	0b00000010, 0b00000001, 0b10111110, // 106 = j
	0b11111110, 0b00001000, 0b00010100, 0b00100010, // 107 = k
	0b11111100, 0b00000010, // 108 = l
	0b00111110, 0b00100000, 0b00011110, 0b00100000, 0b00011110, // 109 = m
	0b00111110, 0b00100000, 0b00100000, 0b00100000, 0b00011110, // 110 = n
	0b00011100, 0b00100010, 0b00100010, 0b00100010, 0b00011100, // 111 = o
	0b00111111, 0b00100100, 0b00100100, 0b00100100, 0b00011000, // 112 = p
	0b00011100, 0b00100010, 0b00100010, 0b00100100, 0b00111111, // 113 = q
	0b00111110, 0b00010000, 0b00100000, 0b00100000, // 114 = r
	0b00010010, 0b00101010, 0b00101010, 0b00101010, 0b00100100, // 115 = s
	0b00100000, 0b01111100, 0b00100010, // 116 = t
	0b00111100, 0b00000010, 0b00000010, 0b00000100, 0b00111110, // 117 = u
	0b00110000, 0b00001100, 0b00000010, 0b00001100, 0b00110000, // 118 = v
	0b00111000, 0b00000110, 0b00111000, 0b00000110, 0b00111000, // 119 = w
	0b00100010, 0b00010100, 0b00001000, 0b00010100, 0b00100010, // 120 = x
	0b00111000, 0b00000101, 0b00000101, 0b00000101, 0b00111110, // 121 = y
	0b00100010, 0b00100110, 0b00101010, 0b00110010, 0b00100010, // 122 = z
	0b00010000, 0b01101100, 0b10000010, // 123 = {
	0b11111111, // 124 = |
	0b10000010, 0b01101100, 0b00010000, // 125 = }
	0b01000000, 0b10000000, 0b01000000, 0b10000000, // 126 = ~
	0b00111000, 0b00101000, 0b01101100, 0b00101000, 0b00010000 // 127 = DEL
};

u8 text_bitmap(u8 c, u8 i) {
	if (c == 0) return 0; // 32 = Space

	u16 s = 0;
	for (u8 j = 0; j < c - 1; j++) s += text_points[j];

	return text_bitmap_data[s + i];
}

u8 text_length(u8 c) {
	if (c == 0) return 4;
	return text_points[c - 1];
}

const u8 text_ticks[7] = {187, 141, 116, 95, 75, 58, 47};

u8 text_port = 0;
u8 text_color = 127;
u8 text_loop = 0;
u8 text_bytes[322] = {};
u16 text_end = 0;

u8 text_speed = 3; // Default speed gets overwritten after changed
u8 text_elapsed = 80;
u16 text_counter = 1;
u8 text_subcounter = 0;

u8 text_frame[10] = {};
u8 text_done = 0;

void text_init() {
	text_elapsed = text_ticks[text_speed];
	text_counter = 1;
	text_subcounter = 0;
	text_done = 0;
	
	for (u8 i = 0; i < 10; i++) text_frame[i] = 0;
}

void text_timer_event() {
	if (++text_elapsed >= text_ticks[text_speed]) { // Next frame
		if (text_done) {
			mode_update(mode_default);
		
		} else {
			for (u8 i = 0; i < 9; i++) text_frame[i] = text_frame[i + 1]; // Shift all frames left
			
			u8 b = 0;
			
			if (text_counter) {
				b = text_bytes[text_counter];
				
				while (b < 8) {
					text_speed = b - 1;
					
					if (++text_counter >= text_end) {
						text_counter = 0;
						break;
					}
					
					b = text_bytes[text_counter];
				}
			}
			
			if (text_counter) {
				b -= 32;

				u8 l = text_length(b);
				
				if (text_subcounter++ < l) {
					text_frame[9] = text_bitmap(b, text_subcounter - 1);
				} else {
					text_frame[9] = 0; // Padding between bytes
				}
				
				if (text_subcounter == l + 2) { // Increment counters
					text_subcounter = 0;
					if (++text_counter >= text_end) {
						text_counter = 0;
					}
				}
			
			} else {
				text_frame[9] = 0;

				int c = 0;
				for (int i = 0; i < 10; i++)
					c += text_frame[i] == 0;
				
				if (c == 10) { // If frames empty
					syx_resp_cpy(novation_header);
					syx_response_buffer[sizeof(syx_novation_header) + 1] = 0x15;
					syx_response_buffer[sizeof(syx_novation_header) + 2] = 0xF7;
					syx_send(text_port, sizeof(syx_novation_header) + 3);
					
					if (text_loop) {
						text_counter = 1;
						text_subcounter = 0;
					
					} else {
						text_done = 1;
					}
				}
			}
			
			for (u8 i = 0; i < 10; i++) display_u8(text_frame[i], 1, i, palette_value(palette_novation, text_color, 0), palette_value(palette_novation, text_color, 1), palette_value(palette_novation, text_color, 2)); // Draw text
			
			text_elapsed = 0;
		}
	}
}

void text_surface_event(u8 p, u8 v, u8 x, u8 y) {
	mode_update(mode_default);
}

void text_midi_event(u8 port, u8 t, u8 ch, u8 p, u8 v) {}

void text_aftertouch_event(u8 v) {}

void text_poly_event(u8 p, u8 v) {}